<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Порівняння моделей Audi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #111;
            color: white;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0 20px 80px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #000;
            padding: 15px 20px;
        }

        header .logo {
            font-size: 26px;
            font-weight: bold;
            color: white;
        }

        .back-btn {
            background: #fff;
            color: #000;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            font-weight: bold;
            cursor: pointer;
        }

        h1 {
            text-align: center;
            margin: 30px 0;
        }

        .slot-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .car-slot {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
            position: relative;
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: #333;
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .car-slot img {
            max-width: 100%;
            max-height: 130px;
            margin-bottom: 10px;
        }

        .view-btn, .remove-btn {
            margin: 8px 4px 0;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .view-btn {
            background: #007aff;
            color: white;
        }

        .remove-btn {
            background: #ff5252;
            color: white;
        }

        .compare-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        .compare-table th, .compare-table td {
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
        }

        .compare-table th {
            background: #222;
        }

        canvas {
            margin-top: 30px;
            max-width: 100%;
        }

        footer {
            margin-top: 60px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">Audi</div>
    <a href="index.html"><button class="back-btn">← Назад</button></a>
</header>

<h1>Порівняння моделей Audi</h1>
<div class="slot-container" id="slots"></div>

<div id="comparisonArea">
    <table id="comparisonTable" class="compare-table" style="display:none;"></table>
    <canvas id="chartCanvas" style="display:none;"></canvas>
</div>

<footer class="audi-footer">
    <!-- футер повністю такий як в index.html -->
    <!-- можна сюди вставити повністю, або просто залишити як є, бо style.css вже його містить -->
</footer>

<script>
    let allCars = [];
    let selectedCars = [null, null, null];

    async function fetchCars() {
        const res = await fetch("/api/cars");
        const data = await res.json();
        allCars = data.map(car => {
            const id = (car.id || "").toLowerCase();
            if (!car.engine) {
                if (id.includes("r8")) car.engine = "5.2L V10";
                else if (id.includes("rs")) car.engine = "4.0L V8 Biturbo";
                else if (id.includes("sq")) car.engine = "3.0L V6 Turbo";
                else if (id.includes("q")) car.engine = "2.0L TFSI Quattro";
                else car.engine = "1.8L TFSI";
            }
            car.transmission ||= "Automatic";
            car.acceleration ||= (Math.random() * 1.5 + 4).toFixed(1);
            car.topSpeed ||= Math.floor(Math.random() * 50 + 230);
            return car;
        });
        renderSlots();
        renderComparison();
    }

    function renderSlots() {
        const container = document.getElementById("slots");
        container.innerHTML = "";
        for (let i = 0; i < 3; i++) {
            const slot = document.createElement("div");
            slot.className = "car-slot";

            const select = document.createElement("select");
            select.innerHTML = `<option value="">Виберіть модель</option>` + allCars.map(car =>
                `<option value="${car.id}">${car.name}</option>`).join('');
            select.value = selectedCars[i]?.id || "";

            select.addEventListener("change", e => {
                const id = e.target.value;
                selectedCars[i] = allCars.find(c => c.id === id) || null;
                renderSlots();
                renderComparison();
            });

            slot.appendChild(select);

            if (selectedCars[i]) {
                const car = selectedCars[i];

                slot.innerHTML += `
          <img src="${car.image}" alt="${car.name}">
          <h3>${car.name}</h3>
          <p>${car.price} €</p>
          <button class="view-btn" onclick="location.href='models/${car.page}'">Переглянути</button>
          <button class="remove-btn" onclick="removeCar(${i})">Видалити</button>
        `;
                slot.prepend(select);
            } else {
                const empty = document.createElement("p");
                empty.style.opacity = 0.5;
                empty.textContent = `Слот ${i + 1}`;
                slot.appendChild(empty);
            }

            container.appendChild(slot);
        }
    }

    function removeCar(index) {
        selectedCars[index] = null;
        renderSlots();
        renderComparison();
    }

    function renderComparison() {
        const table = document.getElementById("comparisonTable");
        const chart = document.getElementById("chartCanvas");
        const cars = selectedCars.filter(Boolean);
        if (cars.length === 0) {
            table.style.display = chart.style.display = "none";
            return;
        }

        table.innerHTML = "";
        table.style.display = "table";
        chart.style.display = "block";

        const rows = [
            ["Назва", ...cars.map(c => c.name)],
            ["Ціна", ...cars.map(c => c.price + " €")],
            ["Двигун", ...cars.map(c => c.engine)],
            ["Коробка", ...cars.map(c => c.transmission)],
            ["Розгін 0-100", ...cars.map(c => c.acceleration + " сек")],
            ["Макс. швидкість", ...cars.map(c => c.topSpeed + " км/г")]
        ];

        for (const row of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<th>${row[0]}</th>` + row.slice(1).map(val => `<td>${val}</td>`).join('');
            table.appendChild(tr);
        }

        drawChart(cars);
    }

    function drawChart(cars) {
        const ctx = document.getElementById("chartCanvas").getContext("2d");
        if (window.chart) window.chart.destroy();
        window.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cars.map(c => c.name),
                datasets: [
                    {
                        label: "Макс. швидкість",
                        data: cars.map(c => parseInt(c.topSpeed)),
                        backgroundColor: "rgba(255, 99, 132, 0.7)"
                    },
                    {
                        label: "Розгін 0-100 (сек)",
                        data: cars.map(c => parseFloat(c.acceleration)),
                        backgroundColor: "rgba(54, 162, 235, 0.7)"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: "#fff" } }
                },
                scales: {
                    x: { ticks: { color: "#fff" } },
                    y: { ticks: { color: "#fff" }, beginAtZero: true }
                }
            }
        });
    }

    window.addEventListener("DOMContentLoaded", fetchCars);
</script>

</body>
</html>
